# K 線交易建模工作流 — 規則集 v1.0

> **核心原則**：先有可解釋的基線，再談優化；沒打敗基線的模型直接丟棄，不輸出金融垃圾。

---

## RULE-0：反金融垃圾原則（Meta Rules）

| # | 規則 |
|---|------|
| R0.1 | 需求未清楚之前，**不產出任何模型或回測結果** |
| R0.2 | 每一步輸出必須能回答「這對交易有什麼用？」，否則視為垃圾 |
| R0.3 | 所有圖表、指標、特徵，若無法量化成**可驗證的規則**，不算輸入 |
| R0.4 | 先確認動機：**優化（賺錢）** vs **理解（洞察）**，方法不同，不混用 |
| R0.5 | 回測漂亮 ≠ 策略有效；必須通過 RULE-6 驗證階段才算通過 |

---

## RULE-1：需求澄清規則（Requirement Clarification）

在任何建模開始前，必須確認以下 7 個維度，缺一不可：

```
[C1] 目標函數      → 你要最大化/最小化什麼？（Sharpe / 勝率 / MDD...）
[C2] 標的與市場    → 哪個市場、哪個幣/股、槓桿上限？
[C3] 顆粒度        → 主週期？是否多週期？當沖/波段/長線？
[C4] 進場規則      → 把「看圖進出場」翻譯成 if-then 條件
[C5] 出場規則      → 止盈 + 止損 + 時間止損（三個都要有）
[C6] 交易成本      → 手續費 + 滑點 + 最小成交量 + 資金規模
[C7] 風險偏好      → 最大可接受回撤？穩健少賺 vs 高報酬高波動？
```

**不得跳過 C5**：止損是必填項，沒有止損的策略不允許建模。

---

## RULE-2：市場邏輯拆解規則（Market Logic Decomposition）

把用戶的「感覺」或「看圖直覺」強制拆成 4 個模組：

```
[M1] 市場狀態辨識   → 現在是趨勢 / 震盪 / 高波動 / 低流動？
                      → 用什麼 K 線特徵可以區分？

[M2] 進場觸發條件   → M1 確認後，還需要什麼訊號才進場？
                      → 條件必須「可量化」（具體數值、比較運算子）

[M3] 出場 / 止損    → 止盈條件（目標位 / 追蹤止盈）
                      → 止損條件（固定點位 / ATR 倍數 / 形態失效點）
                      → 時間止損（最長持倉棒數）

[M4] 倉位管理       → 固定手數 / 凱利公式 / 風險百分比？
                      → 加減倉觸發條件（有的話）
```

**拆解完成標準**：每個模組能直接轉換成 Python 的 `if/else` 或 `pandas` 條件，沒有任何模糊的「感覺好像」描述。

---

## RULE-3：資料工程規則（Data Engineering）

### 3A — 資料品質
```
[D1] 原始 OHLCV 必須對齊時區（UTC 統一）且無重複時間戳記
[D2] 缺失 K 線 > 0.5% → 調查原因，不能直接 forward-fill 蒙混
[D3] 成交量異常值（> 3σ）需標記，不直接刪除，先確認是否真實事件
[D4] 所有資料清洗步驟必須有版本記錄
```

### 3B — 特徵工程（Feature Engineering）
```
[F1] 所有特徵只能使用「當前 K 棒收盤前」已知資料，禁止未來洩漏
[F2] 使用滾動窗口計算指標時，窗口期必須 < 1/10 總樣本數
[F3] 標籤（label）對齊規則：
     → 預測「未來 N 棒的報酬」→ label 從 t+1 開始計算
     → 禁止在 t 時刻用 t 的 close 計算的特徵去預測 t 的 label
[F4] 特徵數上限 = min(50, 樣本數 / 100)
[F5] 所有特徵計算前後必須做單元測試：
     → 最大值/最小值是否合理、有無 NaN 殘留、分布是否穩定
```

### 3C — 資料防洩漏清單（Anti-Leakage Checklist）
- [ ] 特徵計算使用的是 `.shift(1)` 而非原始值？
- [ ] 標準化（scaler）只用訓練集 fit？
- [ ] 回測時每步只能看到「當時已知」的資料？
- [ ] 多週期資料：高週期棒的 close 等到該棒收盤才使用？

---

## RULE-4：基線策略規則（Baseline First）

> 任何複雜模型必須先打敗基線，否則回去改，不允許例外。

```
[B1] 基線 #1（最弱）：Buy & Hold 同期標的報酬
[B2] 基線 #2（中等）：手動看圖規則直接編碼成策略（無 ML）
[B3] 基線 #3（強）：  MA 交叉 或 Bollinger 突破
                      （視標的與週期選擇）

評判標準（需同時滿足）：
  - Sharpe > 基線 Sharpe × 1.2
  - MDD ≤ 基線 MDD × 0.9（或 ≤ C7 設定的可接受上限）
  - 交易頻率合理（手續費不把利潤吃光）
```

---

## RULE-5：建模規則（Modeling Rules）

### 5A — 模型選擇原則（複雜度由低到高）
```
1. 規則型策略（if-then，可解釋）← 通常應先止步於此
2. 線性模型（Logistic / Ridge Regression）
3. 樹型模型（XGBoost / LightGBM）
4. 時序模型（LSTM / TCN）← 只有在前三者均不夠時才用
```

**禁止直接上 Deep Learning**，除非有 > 2 年以上分鐘級資料且前三層模型均已測試並記錄。

### 5B — 超參數調整規則
```
[HP1] 調參只在訓練集上進行，測試集只用一次
[HP2] 調參次數 > 50 次 → 必須用 Bayesian Optimization
[HP3] 參數 ±10% 後 Sharpe 下降 > 20% → 不穩健，拒絕
```

---

## RULE-6：驗證規則（Validation — 禁止用一般 K-Fold）

```
[V1] 時間序列只能用時間切分（Train → Validation → Test，按時間順序）
[V2] 進階：Walk-Forward Validation（走步驗證）
[V3] 標籤重疊 → 必須用 Purged CV + Embargo
[V4] 驗證報告必須含：Sharpe、MDD、勝率、盈虧比、期望值、年份分拆
[V5] OOS Sharpe < 0.8 × IS Sharpe → 疑似過擬合，策略重審
```

---

## RULE-7：回測規則（Backtesting Realism）

```
[BT1] 手續費：必須設定，不得為 0
       → 加密現貨：0.1%；合約 taker：0.04~0.06%
[BT2] 滑點：至少設定 0.05%～0.1%
[BT3] 不得假設「以 close 價格成交」→ 至少假設 next open 或加滑點
[BT4] 回測期間必須包含：1 個牛市段 + 1 個熊市段 + 1 個震盪段
[BT5] 禁止「僅報告最佳時間段」→ 必須報告整個回測期間完整曲線
```

---

## RULE-8：MLOps 追蹤規則

```
[OPS1] 每次實驗必須記錄：
        → 特徵清單 + 版本、模型超參數、訓練/測試集時間範圍
        → 所有評估指標（Sharpe, MDD, Winrate, Expectancy）

[OPS2] 模型版本管理：
        → 通過 V5 的模型打 tag，未通過保留記錄但不升版

[OPS3] 實驗命名規範：
        {標的}_{週期}_{策略類型}_{版本}_{日期}
        例：BTCUSDT_4h_macd_div_v1_20250225
```

---

## RULE-9：上線前規則（Pre-Deployment Checklist）

```
[GO1] 模擬單（Paper Trading）至少跑 30 個交易日
[GO2] 真實資金從 ≤ 5% 總資金開始
[GO3] 設置自動熔斷：
       → 單日虧損 > X%  → 自動停止
       → 連續 N 筆虧損  → 自動停止
       → 模型分布異常   → 停止並發警報
[GO4] 每週「策略健康檢查」：OOS Sharpe 是否持續下降？
[GO5] 波動率超出訓練期範圍 2σ → 降倉或停機
```

---

## RULE-10：迭代規則（Iteration Rules）

```
[IT1] 每次迭代只改一個變數
[IT2] 新想法先開實驗分支，通過 RULE-4+6+7 才合併主版本
[IT3] 策略退化觸發重訓條件：
       → 滾動 60 天 OOS Sharpe < 0.3
       → 滾動 60 天 MDD > 回測 MDD × 1.5
[IT4] 每季做一次完整從零重新驗證
[IT5] 連續 2 季 OOS 不及基線 → 強制停用，從 RULE-1 重來
```

---

## 工作流順序一覽

```
RULE-0  確認不產出垃圾
   ↓
RULE-1  需求澄清（C1～C7 全部確認，C5 止損必填）
   ↓
RULE-2  把「看圖交易」拆成 M1～M4 模組
   ↓
RULE-3  資料清洗 + 特徵工程 + 防洩漏檢查
   ↓
RULE-4  跑基線策略（必須先有基線）
   ↓
RULE-5  建模（複雜度由低到高）
   ↓
RULE-6  Walk-Forward 驗證
   ↓
RULE-7  含交易成本的現實回測
   ↓
RULE-8  實驗記錄（命名規範 + 版本管理）
   ↓
RULE-9  模擬盤 30 天 → 小資金上線 → 熔斷機制就位
   ↓
RULE-10 定期迭代，不符合基準就退回 RULE-1
```
